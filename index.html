<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Allowance Tracker</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        /* Auth Container */
        #authContainer {
            text-align: center;
            padding: 40px;
        }
        
        #authContainer h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        #authContainer button {
            padding: 15px 30px;
            font-size: 1.1em;
        }
        
        /* Logout Button */
        .logout-section {
            text-align: right;
            margin-bottom: 20px;
        }
        
        .logout-btn {
            background: #ef4444;
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .logout-btn:hover {
            background: #dc2626;
        }
        
        .balance-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .balance-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .balance-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .positive {
            color: #4ade80;
        }
        
        .negative {
            color: #f87171;
        }
        
        .settings-section, .spending-section, .proposed-section {
            margin-bottom: 30px;
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        input[type="number"], input[type="date"], input[type="text"] {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            flex: 1;
            min-width: 150px;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .item-list {
            list-style: none;
        }
        
        .item {
            background: #f9fafb;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-name {
            font-weight: bold;
            color: #1f2937;
        }
        
        .item-date {
            font-size: 0.85em;
            color: #6b7280;
        }
        
        .item-amount {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-right: 15px;
        }
        
        .delete-btn {
            background: #ef4444;
            padding: 5px 12px;
            font-size: 0.9em;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .proposed-item {
            background: #fef3c7;
        }
        
        .proposed-item:hover {
            background: #fde68a;
        }
        
        .can-afford {
            background: #d1fae5;
        }
        
        .cannot-afford {
            background: #fee2e2;
        }
        
        .afford-status {
            font-size: 0.85em;
            padding: 4px 8px;
            border-radius: 5px;
            margin-left: 10px;
        }
        
        .afford-yes {
            background: #4ade80;
            color: white;
        }
        
        .afford-no {
            background: #f87171;
            color: white;
        }
        
        /* Compact grid layout for proposed items */
        #proposedList {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }
        
        #proposedList .item {
            padding: 10px;
            margin-bottom: 0;
        }
        
        #proposedList .item-name {
            font-size: 0.95em;
        }
        
        #proposedList .item-amount {
            font-size: 1em;
            margin-right: 10px;
        }
        
        #proposedList .delete-btn {
            padding: 4px 10px;
            font-size: 0.85em;
        }
        
        #proposedList .afford-status {
            font-size: 0.75em;
            padding: 3px 6px;
        }
        
        .proposed-totals {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .proposed-totals-item {
            text-align: center;
        }
        
        .proposed-totals-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .proposed-totals-amount {
            font-size: 1.4em;
            font-weight: bold;
        }
        
        .totals-positive {
            color: #4ade80;
        }
        
        .totals-negative {
            color: #f87171;
        }
    </style>
</head>
<body>
    <!-- Auth Container (shown when not logged in) -->
    <div id="authContainer" class="container">
        <h2>üí∞ Daily Allowance Tracker</h2>
        <p style="margin-bottom: 20px; color: #666;">Sign in to sync your budget across all devices</p>
        <button onclick="signInAnonymously()">Sign In</button>
    </div>
    
    <!-- Main App (shown when logged in) -->
    <div id="app" class="container" style="display: none;">
        <div class="logout-section">
            <button class="logout-btn" onclick="signOut()">Logout</button>
        </div>
        
        <h1>üí∞ Daily Allowance Tracker</h1>
        
        <!-- Balance Overview -->
        <div class="balance-section">
            <h2 style="color: white; margin: 0 0 10px 0;">Your Balance</h2>
            <div class="balance-grid">
                <div class="balance-item">
                    <div class="balance-label">Total Accumulated</div>
                    <div class="balance-amount" id="totalAccumulated">$0.00</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">Total Spent</div>
                    <div class="balance-amount" id="totalSpent">$0.00</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-amount" id="availableBalance">$0.00</div>
                </div>
            </div>
            <div style="margin-top: 20px; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label style="color: white; white-space: nowrap;">Manual Adjustment: $</label>
                    <input type="number" id="manualAdjustment" step="0.01" style="flex: 1; min-width: 150px; padding: 8px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9);">
                    <button onclick="updateManualAdjustment()" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white; padding: 8px 16px;">Update</button>
                </div>
                <div style="color: white; font-size: 0.85em; margin-top: 8px; opacity: 0.9;">
                    Add or subtract from balance (daily allowance will continue to accumulate)
                </div>
            </div>
        </div>
        
        <!-- Proposed Purchases -->
        <div class="proposed-section">
            <h2>üõí Proposed Purchases</h2>
            <div class="input-group">
                <input type="text" id="proposedName" placeholder="What do you want to buy?">
                <input type="number" id="proposedAmount" placeholder="Estimated cost" step="0.01" min="0">
                <button onclick="addProposed()">Add to List</button>
            </div>
            <ul class="item-list" id="proposedList"></ul>
            <div class="proposed-totals">
                <div class="proposed-totals-item">
                    <div class="proposed-totals-label">Total Proposed</div>
                    <div class="proposed-totals-amount" id="totalProposed">$0.00</div>
                </div>
                <div class="proposed-totals-item">
                    <div class="proposed-totals-label">Available Balance</div>
                    <div class="proposed-totals-amount" id="proposedAvailable">$0.00</div>
                </div>
                <div class="proposed-totals-item">
                    <div class="proposed-totals-label">Remaining After</div>
                    <div class="proposed-totals-amount" id="remainingAfter">$0.00</div>
                </div>
            </div>
        </div>
        
        <!-- Spending -->
        <div class="spending-section">
            <h2>üí≥ Record Spending</h2>
            <div class="input-group">
                <input type="text" id="spendingName" placeholder="What did you buy?">
                <input type="number" id="spendingAmount" placeholder="Amount" step="0.01" min="0">
                <input type="date" id="spendingDate">
                <button onclick="addSpending()">Add Spending</button>
            </div>
            <ul class="item-list" id="spendingList"></ul>
        </div>
        
        <!-- Settings -->
        <div class="settings-section">
            <h2>‚öôÔ∏è Settings</h2>
            <div class="input-group">
                <label style="display: flex; align-items: center; gap: 10px; flex: 1;">
                    <span style="white-space: nowrap;">Daily Allowance: $</span>
                    <input type="number" id="dailyAllowance" value="20" step="0.01" min="0">
                </label>
                <label style="display: flex; align-items: center; gap: 10px; flex: 1;">
                    <span style="white-space: nowrap;">Start Date:</span>
                    <input type="date" id="startDate">
                </label>
                <button onclick="updateSettings()">Update Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase Initialization -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA89BZxelKRoK64JnYtSdWUho2WUfWymII",
            authDomain: "capacity-monitor.firebaseapp.com",
            projectId: "capacity-monitor",
            storageBucket: "capacity-monitor.firebasestorage.app",
            messagingSenderId: "455641716280",
            appId: "1:455641716280:web:5848888e290e47114c78cd",
            measurementId: "G-CGR5R0D1SP"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        window.db = db;
        window.currentUser = null;

        // Auth state observer
        auth.onAuthStateChanged(async user => {
            if (user) {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                window.currentUser = user;
                
                // Load data from Firestore
                await loadAllData();
            } else {
                document.getElementById('authContainer').style.display = 'block';
                document.getElementById('app').style.display = 'none';
                window.currentUser = null;
            }
        });
    </script>
    
    <!-- Auth functions -->
    <script src="auth.js"></script>
    
    <!-- Storage functions -->
    <script src="storage.js"></script>
    
    <!-- Firestore functions -->
    <script src="firestore.js"></script>
    
    <!-- Main app logic -->
    <script>
        // App state
        let data = {
            dailyAllowance: 20,
            startDate: new Date().toISOString().split('T')[0],
            manualAdjustment: 0,
            spending: [],
            proposed: []
        };
        
        // Load all data from Firestore
        async function loadAllData() {
            const cloudData = await loadAllDataFromFirestore();
            
            // Load settings
            if (cloudData.settings) {
                data.dailyAllowance = cloudData.settings.dailyAllowance || 20;
                data.startDate = cloudData.settings.startDate || new Date().toISOString().split('T')[0];
                data.manualAdjustment = cloudData.settings.manualAdjustment || 0;
            }
            
            // Load spending and proposed
            data.spending = cloudData.spending;
            data.proposed = cloudData.proposed;
            
            // Update form fields
            document.getElementById('dailyAllowance').value = data.dailyAllowance;
            document.getElementById('startDate').value = data.startDate;
            document.getElementById('manualAdjustment').value = data.manualAdjustment;
            document.getElementById('spendingDate').value = new Date().toISOString().split('T')[0];
            
            updateDisplay();
        }
        
        async function updateSettings() {
            data.dailyAllowance = parseFloat(document.getElementById('dailyAllowance').value) || 0;
            data.startDate = document.getElementById('startDate').value;
            
            const settings = {
                dailyAllowance: data.dailyAllowance,
                startDate: data.startDate,
                manualAdjustment: data.manualAdjustment
            };
            
            await saveSettingsToFirestore(settings);
            updateDisplay();
        }
        
        async function updateManualAdjustment() {
            data.manualAdjustment = parseFloat(document.getElementById('manualAdjustment').value) || 0;
            
            const settings = {
                dailyAllowance: data.dailyAllowance,
                startDate: data.startDate,
                manualAdjustment: data.manualAdjustment
            };
            
            await saveSettingsToFirestore(settings);
            updateDisplay();
        }
        
        function calculateAccumulated() {
            const start = new Date(data.startDate);
            const today = new Date();
            const daysDiff = Math.floor((today - start) / (1000 * 60 * 60 * 24)) + 1;
            const dailyTotal = daysDiff > 0 ? daysDiff * data.dailyAllowance : 0;
            const manualAdj = data.manualAdjustment || 0;
            return dailyTotal + manualAdj;
        }
        
        function calculateTotalSpent() {
            return data.spending.reduce((sum, item) => sum + item.amount, 0);
        }
        
        async function addSpending() {
            const name = document.getElementById('spendingName').value.trim();
            const amount = parseFloat(document.getElementById('spendingAmount').value);
            const date = document.getElementById('spendingDate').value;
            
            if (!name || !amount || amount <= 0 || !date) {
                alert('Please fill in all spending fields');
                return;
            }
            
            const entry = {
                id: Date.now(),
                name: name,
                amount: amount,
                date: date
            };
            
            // Save to Firestore
            await saveSpendingToFirestore(entry);
            
            // Add to local state
            data.spending.push(entry);
            
            // Clear inputs
            document.getElementById('spendingName').value = '';
            document.getElementById('spendingAmount').value = '';
            
            updateDisplay();
        }
        
        async function deleteSpending(id, firestoreId) {
            // Delete from Firestore
            await deleteSpendingFromFirestore(firestoreId);
            
            // Remove from local state
            data.spending = data.spending.filter(item => item.id !== id);
            
            updateDisplay();
        }
        
        async function addProposed() {
            const name = document.getElementById('proposedName').value.trim();
            const amount = parseFloat(document.getElementById('proposedAmount').value);
            
            if (!name || !amount || amount <= 0) {
                alert('Please fill in all proposed purchase fields');
                return;
            }
            
            const item = {
                id: Date.now(),
                name: name,
                amount: amount
            };
            
            // Save to Firestore
            await saveProposedToFirestore(item);
            
            // Add to local state
            data.proposed.push(item);
            
            // Clear inputs
            document.getElementById('proposedName').value = '';
            document.getElementById('proposedAmount').value = '';
            
            updateDisplay();
        }
        
        async function deleteProposed(id, firestoreId) {
            // Delete from Firestore
            await deleteProposedFromFirestore(firestoreId);
            
            // Remove from local state
            data.proposed = data.proposed.filter(item => item.id !== id);
            
            updateDisplay();
        }
        
        function updateDisplay() {
            const accumulated = calculateAccumulated();
            const spent = calculateTotalSpent();
            const available = accumulated - spent;
            
            // Update balance display
            document.getElementById('totalAccumulated').textContent = `$${accumulated.toFixed(2)}`;
            document.getElementById('totalSpent').textContent = `$${spent.toFixed(2)}`;
            document.getElementById('availableBalance').textContent = `$${available.toFixed(2)}`;
            document.getElementById('availableBalance').className = available >= 0 ? 'balance-amount positive' : 'balance-amount negative';
            
            // Update spending list
            const spendingList = document.getElementById('spendingList');
            spendingList.innerHTML = data.spending
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(item => `
                    <li class="item">
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-date">${new Date(item.date).toLocaleDateString()}</div>
                        </div>
                        <span class="item-amount">$${item.amount.toFixed(2)}</span>
                        <button class="delete-btn" onclick="deleteSpending(${item.id}, '${item.firestoreId || ''}')">Delete</button>
                    </li>
                `).join('');
            
            // Update proposed list with affordability
            const proposedList = document.getElementById('proposedList');
            let runningBalance = available;
            const totalProposed = data.proposed.reduce((sum, item) => sum + item.amount, 0);
            
            proposedList.innerHTML = data.proposed.map(item => {
                const canAfford = runningBalance >= item.amount;
                if (canAfford) runningBalance -= item.amount;
                
                return `
                    <li class="item proposed-item ${canAfford ? 'can-afford' : 'cannot-afford'}">
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <span class="afford-status ${canAfford ? 'afford-yes' : 'afford-no'}">
                                ${canAfford ? '‚úì Can Afford' : '‚úó Cannot Afford'}
                            </span>
                        </div>
                        <span class="item-amount">$${item.amount.toFixed(2)}</span>
                        <button class="delete-btn" onclick="deleteProposed(${item.id}, '${item.firestoreId || ''}')">Delete</button>
                    </li>
                `;
            }).join('');
            
            // Update proposed totals
            const remainingAfter = available - totalProposed;
            document.getElementById('totalProposed').textContent = `$${totalProposed.toFixed(2)}`;
            document.getElementById('proposedAvailable').textContent = `$${available.toFixed(2)}`;
            document.getElementById('remainingAfter').textContent = `$${remainingAfter.toFixed(2)}`;
            document.getElementById('remainingAfter').className = remainingAfter >= 0 ? 'proposed-totals-amount totals-positive' : 'proposed-totals-amount totals-negative';
        }
    </script>
</body>
</html>
